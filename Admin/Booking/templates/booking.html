{% extends "layout.html" %}
{% load static %}
{% load i18n %}
{% load booking_extras %}

{% block content %}
<!-- Toast Notifications Container -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2 max-w-xs">
    <!-- Success Toast Template -->
    <div id="success-toast" class="hidden transform translate-x-full transition-transform duration-300 ease-in-out bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-3 rounded-lg shadow-lg border border-green-400 w-full">
        <div class="flex items-center">
            <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
            </svg>
            <div class="flex-1 min-w-0">
                <div id="success-message" class="text-sm font-medium truncate"></div>
            </div>
            <button onclick="hideToast('success-toast')" class="ml-2 text-white hover:text-gray-200 flex-shrink-0">
                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Error Toast Template -->
    <div id="error-toast" class="hidden transform translate-x-full transition-transform duration-300 ease-in-out bg-gradient-to-r from-red-500 to-red-600 text-white px-4 py-3 rounded-lg shadow-lg border border-red-400 w-full">
        <div class="flex items-center">
            <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
            </svg>
            <div class="flex-1 min-w-0">
                <div id="error-message" class="text-sm font-medium truncate"></div>
            </div>
            <button onclick="hideToast('error-toast')" class="ml-2 text-white hover:text-gray-200 flex-shrink-0">
                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Info Toast Template -->
    <div id="info-toast" class="hidden transform translate-x-full transition-transform duration-300 ease-in-out bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-3 rounded-lg shadow-lg border border-blue-400 w-full">
        <div class="flex items-center">
            <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
            </svg>
            <div class="flex-1 min-w-0">
                <div id="info-message" class="text-sm font-medium truncate"></div>
            </div>
            <button onclick="hideToast('info-toast')" class="ml-2 text-white hover:text-gray-200 flex-shrink-0">
                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
    </div>
</div>

<!-- Consolidated Navigation Header -->
<div class="bg-white rounded-xl shadow-md p-6 mb-6 border border-blue-100">
    <!-- Page Title Section -->
    <div class="flex items-center gap-3 mb-4">
        <h2 class="text-xl md:text-2xl font-extrabold text-[#0E6A6A] tracking-tight">Smart Classroom Booking</h2>
    </div>

    <!-- Main Navigation Row -->
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-4">
        <!-- Week Navigation & Title -->
        <div class="flex flex-col md:flex-row md:items-center gap-4">
            <!-- Previous/Next Week Buttons -->
            <div class="flex items-center gap-2">
                <a href="{% url 'booking' %}?week={{ prev_week }}" 
                   class="flex items-center px-3 py-2 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 rounded-lg font-medium shadow hover:shadow-md hover:from-gray-200 hover:to-gray-300 transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-300 text-sm">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Prev
                </a>
                
                <a href="{% url 'booking' %}?week={{ next_week }}" 
                   class="flex items-center px-3 py-2 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700 rounded-lg font-medium shadow hover:shadow-md hover:from-gray-200 hover:to-gray-300 transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-300 text-sm">
                    Next
                    <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </a>
            </div>
            
            <!-- Week Display & Status -->
            <div class="text-center md:text-left">
                <h3 class="text-lg font-bold text-[#0E6A6A]">{{ week_display }}</h3>
                {% if is_current_week %}
                    <span class="inline-block px-2 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded-full">Current Week</span>
                {% elif week_offset < 0 %}
                    <span class="inline-block px-2 py-1 bg-gray-100 text-gray-600 text-xs font-semibold rounded-full">Past Week</span>
                {% else %}
                    <span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded-full">Future Week</span>
                {% endif %}
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex flex-wrap items-center gap-3">
            <!-- Quick Current Week Button (only show if not current week) -->
            {% if not is_current_week %}
            <a href="{% url 'booking' %}" 
               onclick="showToast('info', 'Navigating to current week...')"
               class="px-3 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg font-medium shadow hover:shadow-md transform hover:scale-105 transition duration-200 focus:outline-none focus:ring-2 focus:ring-green-300 text-sm">
                ðŸ“… Current Week
            </a>
            {% endif %}
            
            <!-- Create Booking Button -->
            <a href="{% url 'create_booking' %}?week={{ week_offset }}" 
               onclick="showToast('info', 'Opening booking form...')"
               class="px-4 py-2 bg-gradient-to-r from-[#0E6A6A] to-[#2EC4B6] text-white rounded-lg font-semibold shadow hover:shadow-md transform hover:scale-105 transition duration-200 focus:outline-none focus:ring-2 focus:ring-blue-300 text-sm">
                + Create Booking
            </a>
        </div>
    </div>
    
    <!-- Quick Jump Navigation Row -->
    <div class="border-t border-gray-200 pt-4">
        <div class="flex flex-col sm:flex-row sm:items-center gap-3">
            <span class="text-sm font-medium text-gray-600">Quick Jump:</span>
            <div class="flex flex-wrap gap-2">
                <a href="{% url 'booking' %}?week=-2" 
                   onclick="showToast('info', 'Jumping to 2 weeks ago...')"
                   class="px-2 py-1 rounded-md text-xs font-medium transition {% if week_offset == -2 %}bg-[#0E6A6A] text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                    2w ago
                </a>
                <a href="{% url 'booking' %}?week=-1" 
                   onclick="showToast('info', 'Jumping to last week...')"
                   class="px-2 py-1 rounded-md text-xs font-medium transition {% if week_offset == -1 %}bg-[#0E6A6A] text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                    Last week
                </a>
                <a href="{% url 'booking' %}" 
                   onclick="showToast('info', 'Jumping to current week...')"
                   class="px-2 py-1 rounded-md text-xs font-medium transition {% if is_current_week %}bg-[#0E6A6A] text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                    This week
                </a>
                <a href="{% url 'booking' %}?week=1" 
                   onclick="showToast('info', 'Jumping to next week...')"
                   class="px-2 py-1 rounded-md text-xs font-medium transition {% if week_offset == 1 %}bg-[#0E6A6A] text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                    Next week
                </a>
                <a href="{% url 'booking' %}?week=2" 
                   onclick="showToast('info', 'Jumping 2 weeks ahead...')"
                   class="px-2 py-1 rounded-md text-xs font-medium transition {% if week_offset == 2 %}bg-[#0E6A6A] text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                    2w ahead
                </a>
                <a href="{% url 'booking' %}?week=3" 
                   onclick="showToast('info', 'Jumping 3 weeks ahead...')"
                   class="px-2 py-1 rounded-md text-xs font-medium transition {% if week_offset == 3 %}bg-[#0E6A6A] text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                    3w ahead
                </a>
                <a href="{% url 'booking' %}?week=4" 
                   onclick="showToast('info', 'Jumping 1 month ahead...')"
                   class="px-2 py-1 rounded-md text-xs font-medium transition {% if week_offset == 4 %}bg-[#0E6A6A] text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                    1 month
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Booking calendar table -->
<div class="overflow-x-auto">
  <table class="min-w-full bg-gradient-to-br from-blue-50 to-cyan-50 rounded-2xl shadow-2xl border border-blue-100 text-[15px]">
    <thead>
      <tr>
        <!-- Time column header (sticky) -->
        <th class="p-4 bg-gradient-to-r from-[#0E6A6A] to-[#2EC4B6] text-white border-b border-r text-left sticky left-0 z-20 font-extrabold shadow-inner text-lg tracking-wide rounded-tl-2xl">
          Time
        </th>
        {% for day, date in day_dates %}
        <th class="p-4 bg-gradient-to-b from-blue-100 to-cyan-50 border-b border-r text-center font-bold text-[#0E6A6A] shadow-inner text-lg {% if forloop.last %}rounded-tr-2xl{% endif %}">
          <div class="flex flex-col items-center">
            <span class="text-base font-bold">{{ day }}</span>
            <span class="text-xs text-blue-500 font-normal tracking-wide">{{ date }}</span>
          </div>
        </th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for hour in hours %}
      <tr class="divide-x even:bg-white/60 odd:bg-blue-50/40 hover:bg-cyan-100/40 transition">
        <!-- Time cell -->
        <td class="p-3 bg-gradient-to-r from-gray-50 to-blue-50 border-r font-semibold text-gray-700 sticky left-0 z-10 w-24 shadow-inner text-base {% if forloop.last %}rounded-bl-2xl{% endif %}">
          {% if hour == 0 %}
            12:00 AM
          {% elif hour < 12 %}
            {{ hour }}:00 AM
          {% elif hour == 12 %}
            12:00 PM
          {% else %}
            {{ hour|add:"-12" }}:00 PM
          {% endif %}
        </td>
        {% for day, date in day_dates %}
        <td class="p-0 h-20 text-center relative group cursor-pointer transition {% if forloop.parentloop.last and forloop.last %}rounded-br-2xl{% endif %}">
          {% with booking=None %}
            {% for b in bookings %}
              {% if not booking and b.start_time|date:'l' == day and b.start_time|date:'G'|add:0 == hour %}
                {% with b as booking %}
                  <div class="absolute inset-1 flex flex-col items-center justify-center bg-gradient-to-br {{ user_color_map|dict_get:booking.user.id }} text-white text-xs p-3 rounded-xl shadow-lg border-2 border-green-700 z-10 animate-fade-in">
                    <div class="font-bold text-base mb-1">{{ booking.user.username }}</div>
                    <div class="text-[13px] font-medium">{{ booking.purpose }}</div>
                    <div class="text-[11px] mt-1 bg-white/20 px-2 py-0.5 rounded-full">
                      {{ booking.start_time|date:'g:i A' }}â€“{{ booking.end_time|date:'g:i A' }}
                    </div>
                  </div>
                {% endwith %}
              {% endif %}
            {% endfor %}
            {% if not booking %}
              <div class="flex items-center justify-center h-full w-full">
                <form method="get" action="{% url 'create_booking' %}">
                  <input type="hidden" name="day" value="{{ day }}">
                  <input type="hidden" name="date" value="{{ date }}">
                  <input type="hidden" name="hour" value="{{ hour }}">
                  <input type="hidden" name="week" value="{{ week_offset }}">
                  <button type="submit" 
                          onclick="showToast('info', 'Creating booking for {{ day }} at {{ hour }}:00...')"
                          class="w-11/12 h-5/6 bg-gradient-to-br from-white to-blue-50 border-2 border-dashed border-blue-200 rounded-xl text-blue-500 group-hover:border-[#0E6A6A] group-hover:text-[#0E6A6A] font-semibold text-sm shadow transition duration-200 focus:outline-none focus:ring-2 focus:ring-blue-300">
                    Book
                  </button>
                </form>
              </div>
            {% endif %}
          {% endwith %}
          <div class="absolute inset-0 bg-[#0E6A6A] opacity-0 group-hover:opacity-10 transition rounded-xl pointer-events-none"></div>
        </td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Toast JavaScript -->
<script>
function showToast(type, message) {
    const toastId = type + '-toast';
    const messageId = type + '-message';
    
    // Set the message
    document.getElementById(messageId).textContent = message;
    
    // Show the toast with slide-in animation
    const toast = document.getElementById(toastId);
    toast.classList.remove('hidden', 'translate-x-full');
    toast.classList.add('translate-x-0');
    
    // Add a subtle bounce effect
    setTimeout(() => {
        toast.classList.add('animate-bounce');
        setTimeout(() => {
            toast.classList.remove('animate-bounce');
        }, 600);
    }, 300);
    
    // Auto-hide after 4 seconds (slightly longer for better UX)
    setTimeout(() => {
        hideToast(toastId);
    }, 4000);
}

function hideToast(toastId) {
    const toast = document.getElementById(toastId);
    
    // Slide out animation
    toast.classList.remove('translate-x-0');
    toast.classList.add('translate-x-full');
    
    // Hide completely after animation
    setTimeout(() => {
        toast.classList.add('hidden');
    }, 300);
}

// Enhanced toast for successful actions with icon animation
function showSuccessToast(message) {
    showToast('success', message);
    
    // Add checkmark animation
    const successToast = document.getElementById('success-toast');
    const icon = successToast.querySelector('svg');
    
    setTimeout(() => {
        icon.classList.add('animate-ping');
        setTimeout(() => {
            icon.classList.remove('animate-ping');
        }, 1000);
    }, 500);
}

// Show Django messages as toasts on page load
document.addEventListener('DOMContentLoaded', function() {
    {% if messages %}
        {% for message in messages %}
            {% if message.tags == 'success' %}
                showSuccessToast('{{ message|escapejs }}');
            {% elif message.tags == 'error' %}
                showToast('error', '{{ message|escapejs }}');
            {% else %}
                showToast('info', '{{ message|escapejs }}');
            {% endif %}
        {% endfor %}
    {% endif %}
    
    // Check URL parameters for success/error messages
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('booking_created') === 'true') {
        showSuccessToast('Booking created successfully! Email confirmation sent.');
    }
    if (urlParams.get('booking_error') === 'true') {
        showToast('error', 'Failed to create booking. Please try again.');
    }
    
    // Add keyboard support for closing toasts
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            // Hide all visible toasts
            ['success-toast', 'error-toast', 'info-toast'].forEach(hideToast);
        }
    });
});

// Add click-to-dismiss functionality for the entire toast
document.addEventListener('click', function(e) {
    if (e.target.closest('[id$="-toast"]:not(.hidden)')) {
        const toastId = e.target.closest('[id$="-toast"]').id;
        hideToast(toastId);
    }
});
</script>
{% endblock %}